Card_Type                                 +
s(Card_Age, k=3)                          +  # REDUCED k
s(Transaction_Distance, k=3)              +  # REDUCED k
Authentication_Method                     +
s(Risk_Score, k=3)                        +  # REDUCED k
Is_Weekend,
family = binomial,
data   = train,
method = "REML"
)
cat("=== GAM MODEL SUCCESSFULLY FITTED ===\n\n")
summary(gam_mod)
## --------------------------------------------------------------
## 4. Predictions & ROC Calculation -----------------------------
## --------------------------------------------------------------
test_prob  <- predict(gam_mod, newdata = test, type = "response")
roc_obj    <- roc(test$Fraud_Label, test_prob, quiet = TRUE)
auc_val    <- auc(roc_obj)
cat("\n=== Model Performance ===\n")
cat("AUC:", round(auc_val, 4), "\n")
# Prepare ROC data
roc_df <- data.frame(
fpr = 1 - roc_obj$specificities,
tpr = roc_obj$sensitivities,
threshold = roc_obj$thresholds
)
# Create ROC plot with enhanced styling
p_roc <- ggplot(roc_df, aes(x = fpr, y = tpr)) +
# Add shaded area under ROC curve
geom_ribbon(aes(ymin = 0, ymax = tpr), fill = "#2c7bb6", alpha = 0.2) +
# ROC curve line
geom_line(color = "#2c7bb6", size = 1.5) +
# Diagonal reference line
geom_abline(intercept = 0, slope = 1, linetype = "dashed",
color = "gray50", size = 1) +
# Labels and title
labs(
title = "ROC Curve – GAM Fraud Detector",
subtitle = paste0("AUC = ", round(auc_val, 4),
" | Model: GAM with Smooth Terms"),
x = "False Positive Rate (1 – Specificity)",
y = "True Positive Rate (Sensitivity)",
caption = "Dashed line represents random classifier (AUC = 0.5)"
) +
# Styling
theme_minimal(base_size = 14) +
theme(
plot.title = element_text(face = "bold", size = 16, hjust = 0),
plot.subtitle = element_text(color = "#2c7bb6", size = 12, hjust = 0),
plot.caption = element_text(size = 9, color = "gray50", hjust = 1),
panel.grid.minor = element_blank(),
panel.border = element_rect(color = "gray80", fill = NA, size = 1)
) +
coord_fixed() +
scale_x_continuous(labels = percent_format(accuracy = 1),
breaks = seq(0, 1, 0.2)) +
scale_y_continuous(labels = percent_format(accuracy = 1),
breaks = seq(0, 1, 0.2)) +
# Add AUC annotation
annotate("text", x = 0.6, y = 0.2,
label = paste0("AUC = ", round(auc_val, 4)),
size = 6, fontface = "bold", color = "#2c7bb6")
print(p_roc)
ggsave("GAM_ROC_Curve_Enhanced.png", p_roc, width = 8, height = 8, dpi = 300)
gam_mod <- gam(
Fraud_Label ~
s(Transaction_Amount, k=5)                +  # REDUCED k
Transaction_Type                          +
s(Account_Balance, k=5)                   +  # REDUCED k
Device_Type                               +
Location                                  +
Merchant_Category                         +
IP_Address_Flag                           +
Previous_Fraudulent_Activity              +
s(Daily_Transaction_Count, k=5)           +  # REDUCED k
s(Avg_Transaction_Amount_7d, k=5)         +  # REDUCED k
s(Failed_Transaction_Count_7d, k=5)       +  # REDUCED k
Card_Type                                 +
s(Card_Age, k=5)                          +  # REDUCED k
s(Transaction_Distance, k=5)              +  # REDUCED k
Authentication_Method                     +
s(Risk_Score, k=5)                        +  # REDUCED k
Is_Weekend,
family = binomial,
data   = train,
method = "REML"
)
library(mgcv)
library(pROC)
library(caret)
library(dplyr)
library(ggplot2)
library(scales)
data <- read.csv("synthetic_fraud_dataset.csv", stringsAsFactors = FALSE)
# Convert the target variable and categorical predictors to factors
data$Fraud_Label <- factor(data$Fraud_Label, levels = c(0, 1))
data$Is_Weekend <- factor(data$Is_Weekend)
data$Previous_Fraudulent_Activity <- factor(data$Previous_Fraudulent_Activity)
data$Device_Type <- factor(data$Device_Type)
data$Card_Type <- factor(data$Card_Type)
set.seed(42) # For reproducibility
train_index <- createDataPartition(data$Fraud_Label, p = 0.7, list = FALSE)
train_data <- data[train_index, ]
test_data <- data[-train_index, ]
# Use smooth terms (s()) for continuous variables to capture non-linear fraud patterns.
gam_model <- gam(
Fraud_Label ~ s(Transaction_Amount) +
s(Account_Balance) +
s(Risk_Score) +
s(Transaction_Distance) +
Avg_Transaction_Amount_7d +
Daily_Transaction_Count +
Card_Age +
Is_Weekend +
Previous_Fraudulent_Activity +
Device_Type +
Card_Type,
data = train_data,
family = binomial(link = "logit"), # Logistic GAM for binary classification
method = "REML"
)
test_probabilities <- predict(gam_model, newdata = test_data, type = "response")
# Generate the ROC curve
roc_obj <- roc(test_data$Fraud_Label, test_probabilities)
auc_value <- auc(roc_obj)
# Convert probabilities to classes (using 0.5 threshold)
predicted_classes <- factor(ifelse(test_probabilities > 0.5, 1, 0), levels = c(0, 1))
cm <- confusionMatrix(predicted_classes, test_data$Fraud_Label, positive = "1")
balanced_accuracy <- cm$byClass["Balanced Accuracy"]
# Prepare data for plotting
cm_table <- as.data.frame(cm$table)
names(cm_table) <- c("Pred", "Ref", "Freq")
cm_table <- cm_table %>%
group_by(Ref) %>%
mutate(Pct = Freq/sum(Freq)*100, Label = paste0(Freq, "\n(", round(Pct,1), "%)"))
# Create the heatmap plot
p_cm <- ggplot(cm_table, aes(x = Ref, y = Pred, fill = Freq)) +
geom_tile(color = "white") +
geom_text(aes(label = Label), color = "white", size = 6, fontface = "bold") +
scale_fill_gradient(low = "#2c7bb6", high = "#d7191c") +
labs(title = "Confusion Matrix", x = "Actual (Reference)", y = "Predicted") +
theme_minimal() +
coord_fixed()
print(p_cm)
#install.packages("caret")
library(caret)
data <- read.csv("synthetic_fraud_dataset.csv")
gam_model <- gam(Fraud_Label ~
Merchant_Category +
Is_Weekend +
s(Transaction_Amount) +
s(Account_Balance) +
s(Card_Age),
family = binomial(link = "logit"),
data = data)
plot(gam_model, pages = 1, se = TRUE, rug = TRUE, shade = FALSE)
gam_model <- gam(Fraud_Label ~
Merchant_Category +
Is_Weekend +
s(Transaction_Amount) +
s(Account_Balance) +
s(Card_Age) +
s(Risk_Score),
family = binomial(link = "logit"),
data = data)
plot(gam_model, pages = 1, se = TRUE, rug = TRUE, shade = FALSE)
gam_model <- gam(Fraud_Label ~
Merchant_Category +
Is_Weekend +
s(Transaction_Amount) +
s(Account_Balance) +
s(Risk_Score),
family = binomial(link = "logit"),
data = data)
plot(gam_model, pages = 1, se = TRUE, rug = TRUE, shade = FALSE)
gam_model <- gam(Fraud_Label ~
Merchant_Category +
Is_Weekend +
s(Risk_Score),
family = binomial(link = "logit"),
data = data)
plot(gam_model, pages = 1, se = TRUE, rug = TRUE, shade = FALSE)
# Load libraries
library(readr)        # For loading the CSV
library(dplyr)        # For data manipulation
library(lubridate)    # For timestamp feature engineering
library(caret)        # For train/test split and confusion matrix
library(pROC)         # For ROC curve analysis
library(ROSE)         # For handling imbalanced data (ROSE algorithm)
# --- 0. Install and Load Required Packages ---
# You may need to run this code once to install the packages:
#
install.packages(c("readr", "dplyr", "lubridate", "caret", "pROC", "ROSE", "mgcv", "gratia", "patchwork"))
# Load libraries
library(readr)        # For loading the CSV
library(dplyr)        # For data manipulation
library(lubridate)    # For timestamp feature engineering
library(caret)        # For train/test split and confusion matrix
library(pROC)         # For ROC curve analysis
library(ROSE)         # For handling imbalanced data (ROSE algorithm)
library(mgcv)         # The main GAM package
library(gratia)       # For plotting GAM smooths with ggplot2
library(patchwork)    # For combining plots
library(ggplot2)      # For plotting
# Set a consistent theme for all plots
theme_set(theme_minimal(base_size = 12))
print("--- Step 1: Loading and Preprocessing Data ---")
FILE_PATH <- 'synthetic_fraud_dataset.csv'
df <- read_csv(FILE_PATH, show_col_types = FALSE)
# Feature Engineering: Extract features from Timestamp
df_clean <- df %>%
mutate(
Timestamp = ymd_hms(Timestamp), # Parse timestamp
hour_of_day = hour(Timestamp),  # Extract hour (0-23)
day_of_week = wday(Timestamp, label = TRUE, abbr = FALSE) # Extract day
)
# Define categorical and binary features
categorical_features <- c(
'Transaction_Type', 'Device_Type', 'Merchant_Category', 'Card_Type',
'Authentication_Method', 'IP_Address_Flag',
'Previous_Fraudulent_Activity', 'Is_Weekend'
)
# Convert categorical features and target variable to factors
df_clean <- df_clean %>%
mutate(across(all_of(categorical_features), as.factor)) %>%
mutate(
# Convert target 'Fraud_Label' to a factor with clear level names
Fraud_Label = factor(Fraud_Label,
levels = c(0, 1),
labels = c("Not_Fraud", "Fraud"))
)
# Select only the columns we will use in the model
features_to_use <- c(
'Transaction_Amount', 'Account_Balance', 'Daily_Transaction_Count',
'Avg_Transaction_Amount_7d', 'Failed_Transaction_Count_7d', 'Card_Age',
'Transaction_Distance', 'Risk_Score', 'hour_of_day', 'day_of_week',
categorical_features, 'Fraud_Label'
)
df_model <- df_clean %>%
select(all_of(features_to_use))
print("Cleaned data structure:")
glimpse(df_model)
print("--- Step 2: Creating Stratified Train/Test Split ---")
set.seed(42)
train_index <- createDataPartition(df_model$Fraud_Label,
p = 0.75,
list = FALSE)
train_data <- df_model[train_index, ]
test_data  <- df_model[-train_index, ]
print("Original Training Data Balance:")
print(table(train_data$Fraud_Label))
print("--- Step 3: Handling Class Imbalance with ROSE ---")
train_balanced <- ROSE(Fraud_Label ~ ., data = train_data, seed = 42)$data
print("Balanced Training Data Balance:")
print(table(train_balanced$Fraud_Label))
print("--- Step 4: Defining and Training the GAM ---")
gam_formula <- as.formula(
Fraud_Label ~
s(Transaction_Amount) +
s(Account_Balance) +
s(Daily_Transaction_Count) +
s(Avg_Transaction_Amount_7d) +
s(Failed_Transaction_Count_7d) +
s(Card_Age) +
s(Transaction_Distance) +
s(Risk_Score) +
s(hour_of_day, bs = "cc") +
s(day_of_week, bs="re") +
Transaction_Type +
Device_Type +
Merchant_Category +
Card_Type +
Authentication_Method +
IP_Address_Flag +
Previous_Fraudulent_Activity +
Is_Weekend
)
print("Training GAM... This may take a moment.")
gam_model <- gam(
gam_formula,
data = train_balanced,
family = binomial(link = "logit"),
method = "REML"
)
print("GAM Model Summary:")
summary(gam_model)
print("--- Step 5: Evaluating Model on Test Set ---")
probabilities <- predict(gam_model, newdata = test_data, type = "response")
# --- 5a. ROC Curve and AUC ---
print("Generating and saving ROC Curve...")
roc_obj <- roc(
response = test_data$Fraud_Label,
predictor = probabilities,
levels = c("Not_Fraud", "Fraud"),
positive = "Fraud"
)
print(paste("Test Set AUC:", round(auc(roc_obj), 4)))
roc_plot <- ggroc(roc_obj) +
geom_segment(aes(x = 1, xend = 0, y = 0, yend = 1),
color = "grey", linetype = "dashed") +
ggtitle(paste("ROC Curve (AUC =", round(auc(roc_obj), 4), ")")) +
labs(x = "1 - Specificity (False Positive Rate)",
y = "Sensitivity (True Positive Rate)") +
theme_minimal(base_size = 14)
# Save the plot
ggsave("roc_curve.png", roc_plot, width = 8, height = 6, dpi = 150)
print("Saved plot to roc_curve.png")
# --- 5b. Confusion Matrix ---
print("Generating Confusion Matrix...")
predicted_classes <- ifelse(probabilities > 0.5, "Fraud", "Not_Fraud")
predicted_classes <- factor(predicted_classes, levels = c("Not_Fraud", "Fraud"))
cm <- confusionMatrix(
data = predicted_classes,
reference = test_data$Fraud_Label,
positive = "Fraud"
)
print("Confusion Matrix (Test Set):")
print(cm)
print("--- Step 6: Plotting and saving Smooth Effects ---")
# Use gratia::draw() to create ggplot-based plots of smooth terms
p1 <- draw(gam_model, select = "s(Transaction_Amount)") +
labs(title = "Effect of Transaction Amount",
x = "Transaction Amount",
y = "Contribution to Fraud Risk (Log-Odds)")
p2 <- draw(gam_model, select = "s(Risk_Score)") +
labs(title = "Effect of Risk Score",
x = "Risk Score",
y = "Contribution to Fraud Risk (Log-Odds)")
p3 <- draw(gam_model, select = "s(hour_of_day)") +
labs(title = "Effect of Hour of Day (Cyclic)",
x = "Hour (0-23)",
y = "Contribution to Fraud Risk (Log-Odds)")
p4 <- draw(gam_model, select = "s(Transaction_Distance)") +
labs(title = "Effect of Transaction Distance",
x = "Transaction Distance",
y = "Contribution to Fraud Risk (Log-Odds)")
# Combine the plots into one visualization
combined_plots <- (p1 + p2) / (p3 + p4) +
plot_annotation(title = "GAM Smooth Effects: Uncovering Fraud Patterns")
# Save the combined plot
ggsave("gam_smooth_effects.png", combined_plots, width = 12, height = 10, dpi = 150)
print("Saved combined plot to gam_smooth_effects.png")
print("--- R Script Complete ---")
# Convert the target variable and categorical predictors to factors
data$Fraud_Label <- factor(data$Fraud_Label, levels = c(0, 1))
data$Is_Weekend <- factor(data$Is_Weekend)
data$Previous_Fraudulent_Activity <- factor(data$Previous_Fraudulent_Activity)
data$Device_Type <- factor(data$Device_Type)
data$Card_Type <- factor(data$Card_Type)
set.seed(42) # For reproducibility
train_index <- createDataPartition(data$Fraud_Label, p = 0.7, list = FALSE)
train_data <- data[train_index, ]
test_data <- data[-train_index, ]
# Use smooth terms (s()) for continuous variables to capture non-linear fraud patterns.
gam_model <- gam(
Fraud_Label ~ s(Transaction_Amount) +
s(Account_Balance) +
s(Risk_Score) +
s(Transaction_Distance) +
Avg_Transaction_Amount_7d +
Daily_Transaction_Count +
Card_Age +
Is_Weekend +
Previous_Fraudulent_Activity +
Device_Type +
Card_Type,
data = train_data,
family = binomial(link = "logit"), # Logistic GAM for binary classification
method = "REML"
)
test_probabilities <- predict(gam_model, newdata = test_data, type = "response")
# Generate the ROC curve
roc_obj <- roc(test_data$Fraud_Label, test_probabilities)
auc_value <- auc(roc_obj)
# Convert probabilities to classes (using 0.5 threshold)
predicted_classes <- factor(ifelse(test_probabilities > 0.5, 1, 0), levels = c(0, 1))
cm <- confusionMatrix(predicted_classes, test_data$Fraud_Label, positive = "1")
balanced_accuracy <- cm$byClass["Balanced Accuracy"]
print(cm)
gam_model <- gam(Fraud_Label ~
Merchant_Category +
Is_Weekend +
s(Transaction_Amount) +
s(Account_Balance) +
s(Card_Age) +
s(Risk_Score),
family = binomial(link = "logit"),
data = data)
summary(gam_model)
par(mfrow = c(2, 2))  # 2 rows, 2 columns
plot(gam_model, se = TRUE, rug = TRUE, shade = TRUE)
par(mfrow = c(1, 1))  # Reset to default
par(mfrow = c(1, 4))  # 1 row, 4 columns
plot(gam_model, se = TRUE, rug = TRUE, shade = TRUE)
par(mfrow = c(1, 1))  # Reset to default
par(mfrow = c(4, 1))  # 4 rows, 1 column
plot(gam_model, se = TRUE, rug = TRUE, shade = TRUE)
par(mfrow = c(1, 1))  # Reset to default
par(mfrow = c(2, 2),
mar = c(4, 4, 2, 1),  # bottom, left, top, right margins
oma = c(0, 0, 2, 0))  # outer margins
plot(gam_model, se = TRUE, rug = TRUE, shade = TRUE,
col = "blue", lwd = 2)
title("GAM Smooth Terms for Fraud Detection", outer = TRUE)
par(mfrow = c(1, 1))  # Reset to default
plot(gam_model, pages = 1, se = TRUE, rug = TRUE, shade = FALSE)
png("gam_smooth_terms.png", width = 1200, height = 800, res = 120)
par(mfrow = c(2, 2))
plot(gam_model, se = TRUE, rug = TRUE, shade = TRUE)
dev.off()
pdf("gam_smooth_terms.pdf", width = 12, height = 8)
par(mfrow = c(2, 2))
plot(gam_model, se = TRUE, rug = TRUE, shade = TRUE)
dev.off()
summary(gam_model)
plot(gam_model, pages = 1, se = TRUE, rug = TRUE, shade = FALSE)
plot(gam_model, se = TRUE, rug = TRUE, shade = FALSE)
par(mfrow = c(1, 4))  # 1 row, 4 columns
plot(gam_model, se = TRUE, rug = TRUE, shade = TRUE)
par(mfrow = c(1, 1))  # Reset to default
par(mfrow = c(4, 1))  # 4 rows, 1 column
plot(gam_model, se = TRUE, rug = TRUE, shade = TRUE)
par(mfrow = c(2, 2))  # 2 rows, 2 columns
plot(gam_model, pages = 1, se = TRUE, rug = TRUE, shade = FALSE)
par(mfrow = c(2, 2), mar = c(4, 4, 3, 2))
plot(gam_model, select = 1, shade = TRUE, col = "blue", lwd = 2,
shade.col = "lightblue", main = "s(Transaction_Amount)")
plot(gam_model, select = 2, shade = TRUE, col = "green4", lwd = 2,
shade.col = "lightgreen", main = "s(Account_Balance)")
plot(gam_model, select = 3, shade = TRUE, col = "purple", lwd = 2,
shade.col = "plum", main = "s(Card_Age)")
plot(gam_model, select = 4, shade = TRUE, col = "red", lwd = 2,
shade.col = "pink", main = "s(Risk_Score)")
par(mfrow = c(1, 1))
par(mfrow = c(2, 2),
mar = c(4, 4, 3, 2),
bg = "white")
plot(gam_model, shade = TRUE, col = "darkblue", lwd = 3,
shade.col = "skyblue", rug = TRUE,
col.axis = "darkblue", col.lab = "darkblue")
par(mfrow = c(1, 1))
colors <- c("red", "orange", "green4", "blue")
shade_colors <- c("pink", "lightyellow", "lightgreen", "lightblue")
par(mfrow = c(2, 2), mar = c(4, 4, 3, 2))
for(i in 1:4) {
plot(gam_model, select = i, shade = TRUE,
col = colors[i], lwd = 3,
shade.col = shade_colors[i])
}
par(mfrow = c(1, 1))
png("gam_colorful_plots.png", width = 1200, height = 1000, res = 120)
par(mfrow = c(2, 2), mar = c(4, 4, 3, 2))
plot(gam_model, select = 1, shade = TRUE, col = "blue", lwd = 3,
shade.col = "lightblue", main = "Transaction Amount Effect")
plot(gam_model, select = 2, shade = TRUE, col = "green4", lwd = 3,
shade.col = "lightgreen", main = "Account Balance Effect")
plot(gam_model, select = 3, shade = TRUE, col = "purple", lwd = 3,
shade.col = "plum", main = "Card Age Effect")
plot(gam_model, select = 4, shade = TRUE, col = "red", lwd = 3,
shade.col = "pink", main = "Risk Score Effect")
dev.off()
par(mfrow = c(1, 1))
par(mfrow = c(2, 2), mar = c(4, 4, 3, 2))
plot(gam_model, select = 1, shade = TRUE, col = "blue", lwd = 2,
shade.col = "lightblue", main = "s(Transaction_Amount)")
plot(gam_model, select = 2, shade = TRUE, col = "green4", lwd = 2,
shade.col = "lightgreen", main = "s(Account_Balance)")
plot(gam_model, select = 3, shade = TRUE, col = "purple", lwd = 2,
shade.col = "plum", main = "s(Card_Age)")
plot(gam_model, select = 4, shade = TRUE, col = "red", lwd = 2,
shade.col = "pink", main = "s(Risk_Score)")
par(mfrow = c(1, 1))
# Create a tidy table of smooth terms and parametric coefficients
library(broom)
# Smooth terms (edf, chi-sq, p-values)
smooth_terms <- summary(gam_model)$s.table
smooth_df <- data.frame(
Term = rownames(smooth_terms),
EDF = smooth_terms[, "edf"],
ChiSq = smooth_terms[, "Chi.sq"],
p_value = smooth_terms[, "p-value"]
)
# Parametric terms (linear + categorical)
param_df <- tidy(gam_model)
# Combine into one table
model_table <- list(
Smooth_Terms = smooth_df,
Parametric_Terms = param_df
)
# Print tables
model_table$Smooth_Terms
model_table$Parametric_Terms
print(gam_model)
# Use smooth terms (s()) for continuous variables to capture non-linear fraud patterns.
gam_model <- gam(
Fraud_Label ~ s(Transaction_Amount) +
s(Account_Balance) +
s(Risk_Score) +
s(Transaction_Distance) +
Avg_Transaction_Amount_7d +
Daily_Transaction_Count +
Card_Age +
Is_Weekend +
Previous_Fraudulent_Activity +
Device_Type +
Card_Type,
data = train_data,
family = binomial(link = "logit"), # Logistic GAM for binary classification
method = "REML"
)
print(gam_model)
summary(gam_model)
